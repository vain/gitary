#!/bin/bash

# Get the real basedir by resolving any links.
basedir=$(dirname "$(readlink -e "$0")")

# Include further functions.
source "$basedir/gitary-functions" || exit 1

# Use default settings as fallback.
default_prefix=${XDG_DATA_HOME:-$HOME/.local/share}
datadir=${GITARY_DATA:-$default_prefix/gitary}
editor=${EDITOR:-vim}
pager=${PAGER:-less}

# Check if the user only wants to view the help page. If so, display it
# and exit. This does not check whether the data dir exists.
case "$1" in
	help|-h|-help|--help)
		man -M "$basedir" gitary
		exit 1
		;;
esac

# Okay, now check the data dir and process all other options.
checkdatadir || exit 1

if [[ -z "$1" ]]
then
	# Create a new entry for today.
	edit "$(date +%F)"
	exit
fi

# Remove up to two leading dashes from $1.
opt=${1#-}
case "${opt#-}" in
	tags)
		# Only search for tags.
		shift
		search "$@"
		;;
	refs)
		# Only search for references.
		shift
		search -r "$@"
		;;
	search)
		# Search whole entries.
		shift
		search -a "$@"
		;;
	gitk)
		(
			cd "$datadir"
			gitk --all
		)
		;;
	edit|view)
		# Edit or create an arbitrary entry.
		shift
		edit "$@"
		;;
	viewall)
		# Show all entries in chronological order.
		viewall
		;;
	alltopics)
		# Show all topics. A time range may be given as an optional
		# argument.
		shift
		alltopics "$@"
		;;
	alltags)
		# Show all tags. Similar to --alltopics, a time range may be
		# given.
		shift
		alltags "$@"
		;;
	addblobs)
		# Add all files as blobs for the current day.
		shift
		addblobs "$@"
		;;
	printblobdir)
		# Prints the blob directory, so you can easily work with it.
		printblobdir
		;;
	*)
		echo "$(basename "$0"): Invalid option \`$1'. See man page." >&2
		exit 1
		;;
esac

# vim: set ts=4 sw=4 :
