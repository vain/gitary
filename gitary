#!/bin/bash

# Get the real basedir by resolving any links.
BASEDIR=$(dirname "$(readlink -e "$0")")

# Include further functions.
source "$BASEDIR/gitary-functions" || exit 1

# Default settings.
DATADIR="${XDG_DATA_HOME:-$HOME/.local/share}/gitary"
EDITOR="${EDITOR:-vim}"
PAGER="${PAGER:-less}"

# EDITOR and PAGER must be arrays. That's the only way to allow spaces
# in arguments (see config).
EDITOR=("$EDITOR")
PAGER=("$PAGER")

# Read user settings, maybe overwrite defaults. Try $XDG_CONFIG_HOME and
# use $HOME/.config as a fallback.
CONFIGFILE="${XDG_CONFIG_HOME:-$HOME/.config}/gitaryrc"
[[ -f "$CONFIGFILE" ]] && source "$CONFIGFILE"

checkdatadir

cd "$DATADIR" || exit 1

case "$1" in
	tags|-tags|--tags)
		# Only search for tags.
		shift
		search "$@"
		;;
	refs|-refs|--refs)
		# Only search for references.
		shift
		search -r "$@"
		;;
	search|-search|--search)
		# Search whole entries.
		shift
		search -a "$@"
		;;
	gitk|-gitk|--gitk)
		gitk --all
		;;
	pull|-pull|--pull)
		git pull
		;;
	help|-h|-help|--help)
		man -M "$BASEDIR" gitary
		exit 1
		;;
	edit|-edit|--edit)
		# Edit or create an arbitrary entry.
		shift
		edit "$1.gitary"
		;;
	viewall|-viewall|--viewall)
		# Show all entries in chronological order.
		viewall
		;;
	*)
		# Create a new entry for today.
		edit "$(date +%F).gitary"
		;;
esac

# vim: set ts=4 sw=4 :
